var jlab=jlab||{};jlab.epics2web=jlab.epics2web||{};(function(){if(typeof window.CustomEvent==="function"){return false}function a(c,d){d=d||{bubbles:false,cancelable:false,detail:undefined};var b=document.createEvent("CustomEvent");b.initCustomEvent(c,d.bubbles,d.cancelable,d.detail);return b}a.prototype=window.Event.prototype;window.CustomEvent=a})();jlab.epics2web.ClientConnection=function(k){var i="ws:";if(window.location.protocol==="https:"){i="wss:"}var c={url:i+"//"+window.location.host+"/epics2web/monitor",autoOpen:true,autoReconnect:true,autoLivenessPingAndTimeout:true,autoDisplayClasses:true,pingIntervalMillis:8000,livenessTimoutMillis:2000,reconnectWaitMillis:10000,chunkedRequestPvsCount:400};if(!k){k={}}for(var g in c){if(typeof k[g]!=="undefined"){this[g]=k[g]}else{this[g]=c[g]}}var h=null,f=document.createElement("div"),e=null,j=this,d=null,a=false;var b=function(){if(h!==null&&h.readyState===WebSocket.OPEN){j.ping();if(d!==null){}else{d=setTimeout(function(){if(h.readyState===WebSocket.OPEN){h.close()}d=null},j.livenessTimoutMillis)}}else{}};f.addEventListener("open",function(l){j.onopen(l)});f.addEventListener("close",function(l){j.onclose(l)});f.addEventListener("connecting",function(l){j.onconnecting(l)});f.addEventListener("closing",function(l){j.onclosing(l)});f.addEventListener("error",function(l){j.onerror(l)});f.addEventListener("message",function(l){j.onmessage(l)});f.addEventListener("info",function(l){j.oninfo(l)});f.addEventListener("update",function(l){j.onupdate(l)});f.addEventListener("pong",function(l){j.onpong(l)});this.addEventListener=f.addEventListener.bind(f);this.removeEventListener=f.removeEventListener.bind(f);this.dispatchEvent=f.dispatchEvent.bind(f);this.open=function(){if(h===null||h.readyState===WebSocket.CLOSED){var l=new CustomEvent("connecting");f.dispatchEvent(l);h=new WebSocket(this.url);h.onerror=function(m){console.log("server connection error");console.log(m);var m=new CustomEvent("error");f.dispatchEvent(m)};h.onclose=function(m){console.log("server connection closed");console.log(m.reason);var m=new CustomEvent("close");f.dispatchEvent(m);if(d!==null){clearTimeout(d);d=null}var n=h===null||h.readyState===WebSocket.CLOSED;if(j.autoReconnect&&!a&&n){a=true;setTimeout(function(){j.open();a=false},j.reconnectWaitMillis)}else{}};h.onmessage=function(n){if(d!==null){clearTimeout(d);d=null}e=new Date();var m=JSON.parse(n.data);m.date=e;if(m.type==="update"){var n=new CustomEvent("update",{detail:m});f.dispatchEvent(n)}else{if(m.type==="info"){var n=new CustomEvent("info",{detail:m});f.dispatchEvent(n)}else{if(m.type==="pong"){var n=new CustomEvent("pong");f.dispatchEvent(n)}}}var n=new CustomEvent("message");f.dispatchEvent(n,{detail:m})};h.onopen=function(m){e=new Date();var m=new CustomEvent("open");f.dispatchEvent(m)}}else{console.log("already connected");return 1}};this.close=function(l,m){console.log("close");if(h!==null&&h.readyState!==WebSocket.CLOSED){if(typeof l==="undefined"){l=1000}h.close(l,m)}else{console.log("already closed")}};this.monitorPvs=function(l){if(j.chunkedRequestPvsCount>0){var o,n,m;for(o=0,n=l.length;o<n;o+=j.chunkedRequestPvsCount){m=l.slice(o,o+j.chunkedRequestPvsCount);this.monitorPvsChunk(m)}}else{this.monitorPvsChunk(l)}};this.monitorPvsChunk=function(l){var m={type:"monitor",pvs:l};h.send(JSON.stringify(m))};this.clearPvs=function(l){if(j.chunkedRequestPvsCount>0){var o,n,m;for(o=0,n=l.length;o<n;o+=j.chunkedRequestPvsCount){m=l.slice(o,o+j.chunkedRequestPvsCount);this.clearPvsChunk(m)}}else{this.clearPvsChunk(l)}};this.clearPvsChunk=function(l){var m={type:"clear",pvs:l};h.send(JSON.stringify(m))};this.ping=function(){var l={type:"ping"};h.send(JSON.stringify(l))};if(this.autoDisplayClasses===true){f.addEventListener("connecting",function(l){$(".ws-disconnected").hide();$(".ws-connected").hide();$(".ws-connecting").show()});f.addEventListener("open",function(l){$(".ws-disconnected").hide();$(".ws-connected").show();$(".ws-connecting").hide()});f.addEventListener("close",function(l){$(".ws-disconnected").show();$(".ws-connected").hide();$(".ws-connecting").hide()})}if(this.autoOpen===true){this.open()}if(this.autoLivenessPingAndTimeout===true){window.setInterval(b,this.pingIntervalMillis)}};jlab.epics2web.ClientConnection.prototype.onopen=function(){};jlab.epics2web.ClientConnection.prototype.onclose=function(){};jlab.epics2web.ClientConnection.prototype.onconnecting=function(){};jlab.epics2web.ClientConnection.prototype.onclosing=function(){};jlab.epics2web.ClientConnection.prototype.onmessage=function(){};jlab.epics2web.ClientConnection.prototype.onerror=function(){};jlab.epics2web.ClientConnection.prototype.onupdate=function(){};jlab.epics2web.ClientConnection.prototype.oninfo=function(){};jlab.epics2web.ClientConnection.prototype.onpong=function(){};jlab.epics2web.isNumericEpicsType=function(a){var b;switch(a){case"DBR_DOUBLE":case"DBR_FLOAT":case"DBR_INT":case"DBR_SHORT":case"DBR_BYTE":b=true;break;default:b=false}return b};


